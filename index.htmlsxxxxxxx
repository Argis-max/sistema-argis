<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiber Master Pro v29.5 - ARGIS FINAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --primary: #0f172a; --accent: #4f46e5; --modular: #f39c12; --switch: #10b981; --edfa: #e11d48; --olt: #8b5cf6; --proyectado: #f59e0b; --danado: #475569; }
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; color: #000; }
        
        #loginScreen { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; color: white; }
        .login-box { background: white; padding: 25px; border-radius: 12px; color: #334155; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        
        /* Estilo para el mensaje de carga */
        #loginMsg { margin-top: 10px; font-size: 0.85rem; color: var(--accent); font-weight: bold; display: none; }

        .fixed-top-container { flex-shrink: 0; z-index: 100; background: #f1f5f9; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header-top { background: #0f172a; padding: 10px; display: flex; align-items: center; justify-content: space-between; color: white; min-height: 50px; }
        .btn-menu-open { background: var(--accent); color: white; border: none; padding: 10px 15px; border-radius: 6px; font-weight: 800; font-size: 0.75rem; cursor: pointer; display: none; }
        .btn-save-top { background: var(--edfa); color: white; border: none; padding: 10px 15px; border-radius: 6px; font-weight: 900; font-size: 0.75rem; cursor: pointer; display: none; }
        
        .search-area { background: #fff; padding: 8px 12px; border-bottom: 1px solid #e2e8f0; }
        .search-input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 0.85rem; box-sizing: border-box; }
        
        .status-pill-container { display: flex; gap: 4px; overflow-x: auto; padding: 8px 12px; background: #fff; border-bottom: 1px solid #e2e8f0; }
        .pill { padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 800; background: white; border: 1px solid #e2e8f0; white-space: nowrap; }
        
        .scroll-section { flex-grow: 1; overflow: auto; background: #fff; }
        table { width: 100%; min-width: 1100px; border-collapse: separate; border-spacing: 0; table-layout: fixed; }
        th { background: var(--primary); color: white; padding: 8px; text-align: left; font-size: 0.55rem; position: sticky; top: 0; z-index: 10; border-right: 1px solid #334155; }
        td { padding: 6px; border-bottom: 1px solid #f1f5f9; font-size: 0.68rem; }

        .sidebar-left { position: fixed; top: 0; left: -260px; width: 260px; height: 100%; background: #1e293b; transition: 0.3s ease; z-index: 400; padding-top: 20px; }
        .sidebar-left.active { left: 0; }
        .side-item { padding: 15px 20px; color: #cbd5e1; cursor: pointer; border-bottom: 1px solid #334155; font-weight: 700; font-size: 0.85rem; }
        
        .panel-floating { position: fixed; background: white; transition: 0.3s ease; z-index: 500; padding: 20px; box-shadow: 0 0 25px rgba(0,0,0,0.4); display: none; flex-direction: column; border-radius: 12px; box-sizing: border-box; }
        .panel-floating.active { 
            display: flex; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 95%; 
            max-width: 450px; 
            max-height: 85vh; 
            overflow-y: auto; 
        }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 350; backdrop-filter: blur(2px); }
        .overlay.active { display: block; }

        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 400px) { .grid-form { grid-template-columns: 1fr; } } 

        .form-group { display: flex; flex-direction: column; }
        label { font-size: 0.65rem; font-weight: 800; color: #64748b; margin-bottom: 2px; text-transform: uppercase; }
        input, select { padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; } 
        
        .admin-only { display: none; }
        .color-tag { display: block; padding: 2px; border-radius: 3px; color: white; text-align: center; font-weight: 800; font-size: 0.6rem; }
        .input-inline { width: 100%; border: none; background: transparent; outline: none; }
        .btn-danger { background: #e11d48; color: white; border: none; padding: 5px; border-radius: 4px; cursor: pointer; }
        .btn-edit { background: #3b82f6; color: white; border: none; padding: 5px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <h2 style="margin:0 0 20px 0; color:#0f172a">ARGIS SYSTEM</h2>
        <input type="text" id="userInput" placeholder="Usuario">
        <input type="password" id="passInput" placeholder="Contrase√±a">
        <button id="btnLogin" onclick="login()" style="background:var(--accent); color:white; border:none; width:100%; padding:14px; border-radius:6px; cursor:pointer; font-weight:bold;">INGRESAR</button>
        <div id="loginMsg">Cargando base de datos...</div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closePanels()"></div>

<div class="fixed-top-container">
    <div class="header-top">
        <button id="btnMenu" class="btn-menu-open admin-only" onclick="toggleSidebar()">‚ò∞ MEN√ö</button>
        <div style="font-weight: 900; font-size: 0.8rem;">FIBER MASTER <span id="userTag" style="font-size:0.55rem; background:var(--accent); padding:2px 4px; border-radius:3px;"></span></div>
        <div style="display:flex; gap:8px;">
            <button id="btnSaveTop" class="btn-save-top admin-only" onclick="sincronizarGoogle()">GUARDAR</button>
            <button onclick="location.reload()" style="background:#475569; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-size:0.7rem; font-weight:bold;">SALIR</button>
        </div>
    </div>
    <div class="search-area">
        <input type="text" id="search" class="search-input" placeholder="üîç Buscar cliente, HUB, puerto..." onkeyup="renderAll()">
    </div>
    <div class="status-pill-container">
        <div class="pill">TOTAL: <b id="cTotal">0</b></div>
        <div class="pill" style="border-left: 3px solid #10b981">LIBRE: <b id="cLibre">0</b></div>
        <div class="pill" style="border-left: 3px solid #ef4444">USO: <b id="cOcupado">0</b></div>
        <div class="pill" style="border-left: 3px solid var(--proyectado)">PROY: <b id="cProy">0</b></div>
        <div class="pill" style="border-left: 3px solid var(--danado)">FALLO: <b id="cDanado">0</b></div>
    </div>
</div>

<nav class="sidebar-left" id="sidebar">
    <div class="side-item" onclick="openPanel('TR')">üü¶ 1. TRONCALES</div>
    <div class="side-item" onclick="openPanel('MOD')">üüß 2. PORTAMODULARES</div>
    <div class="side-item" onclick="openPanel('SW')">üü© 3. SWITCHES</div>
    <div class="side-item" onclick="openPanel('EDFA')">üü• 4. EDFA WDM</div>
    <div class="side-item" onclick="openPanel('OLT')">üü™ 5. OLT</div>
    <div class="side-item admin-only" onclick="openPanel('USERS')" style="color:#fbbf24; border-top:1px solid #475569;">üë• USUARIOS</div>
    <div class="side-item admin-only" onclick="openPanel('FILES')">üìÅ EXPORTAR / SISTEMA</div>
</nav>

<aside class="panel-floating" id="panelFields">
    <div style="border-bottom: 1px solid #eee; padding-bottom:10px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
        <span id="panelTitle" style="font-weight:900; color:var(--primary); font-size: 0.9rem;"></span> <span onclick="closePanels()" style="cursor:pointer; font-size:1.8rem; padding:0 10px;">&times;</span>
    </div>
    <div id="panelContent"></div>
    <button id="btnAction" style="width:100%; padding:15px; border:none; border-radius:8px; color:white; font-weight:bold; cursor:pointer; margin-top:20px; font-size: 1rem;">EJECUTAR</button>
</aside>

<main class="scroll-section">
    <table>
        <thead>
            <tr>
                <th style="width:110px">HUB</th><th style="width:70px">REF</th><th style="width:60px">CAP</th><th style="width:100px">BUFFER/SLOT</th><th style="width:150px">ALIM</th><th style="width:100px">PTO</th><th style="width:250px">CLIENTE</th><th style="width:80px">dBm</th><th style="width:80px">ESTADO</th><th style="width:50px">KM</th><th class="admin-only" style="width:40px">-</th>
            </tr>
        </thead>
        <tbody id="dataTable"></tbody>
    </table>
</main>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx0VwQndzCCWwJpaE9ARqVZf05SB3L5_Ut-_xcNmW7J-lGN4G5p7YiwgcKpWfttrQA1/exec";
    let db = [];
    let usersDB = { "admin": { pass: "admin123", role: "ADMIN" } };
    let currentUser = null;

    const colors = [{n:"Azul",b:"#0000FF"},{n:"Naranja",b:"#FF8C00"},{n:"Verde",b:"#008000"},{n:"Marr√≥n",b:"#8B4513"},{n:"Gris",b:"#808080"},{n:"Blanco",b:"#FFFFFF",c:"#000"},{n:"Rojo",b:"#FF0000"},{n:"Negro",b:"#000000"},{n:"Amarillo",b:"#FFFF00",c:"#000"},{n:"Violeta",b:"#EE82EE",c:"#000"},{n:"Rosa",b:"#FFC0CB",c:"#000"},{n:"Aqua",b:"#00FFFF",c:"#000"}];

    async function login() {
        const u = document.getElementById('userInput').value.toLowerCase().trim();
        const p = document.getElementById('passInput').value;
        const msg = document.getElementById('loginMsg');
        const btn = document.getElementById('btnLogin');

        if (usersDB[u] && usersDB[u].pass === p) {
            currentUser = { name: u, ...usersDB[u] };
            
            // Mostrar mensaje de carga y ocultar bot√≥n
            msg.style.display = 'block';
            btn.style.display = 'none';

            try {
                const res = await fetch(WEB_APP_URL);
                const data = await res.json();
                if (data.base) db = data.base;
                if (data.usuarios) usersDB = data.usuarios;
            } catch (e) { 
                console.warn("Modo Offline"); 
            }

            document.getElementById('loginScreen').style.display = 'none';
            applyPermissions();
            renderAll();
        } else { 
            alert("Error de acceso"); 
        }
    }

    function applyPermissions() {
        if (!currentUser) return;
        const isAdmin = (currentUser.role === "ADMIN");
        document.getElementById('userTag').innerText = currentUser.name.toUpperCase();
        if (isAdmin) {
            document.getElementById('btnMenu').style.display = 'block';
            document.getElementById('btnSaveTop').style.display = 'block';
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = (el.tagName === 'TH' || el.tagName === 'TD') ? 'table-cell' : 'block';
            });
        }
    }

    function openPanel(type) {
        const content = document.getElementById('panelContent');
        const btn = document.getElementById('btnAction');
        const title = document.getElementById('panelTitle');
        document.getElementById('panelFields').classList.add('active');
        document.getElementById('overlay').classList.add('active');
        btn.style.display = 'block';

        if(type === 'TR') {
            title.innerText = "üü¶ NUEVA TRONCAL"; btn.style.background = "var(--primary)";
            content.innerHTML = `<div class="grid-form">
                <div class="form-group"><label>HUB</label><input id="f1" value="HUB-01"></div>
                <div class="form-group"><label>ODF / BANDEJA</label><input id="f2" value="ODF-01"></div>
                <div class="form-group"><label>CABLE / FIBRA</label><input id="f3" value="T-01"></div>
                <div class="form-group"><label>CAPACIDAD</label><select id="f4"><option value="12">12</option><option value="24" selected>24</option><option value="48">48</option><option value="96">96</option><option value="144">144</option><option value="288">288</option><option value="432">432</option></select></div>
                <div class="form-group"><label>RANGO INICIO</label><input id="f5" type="number" value="1"></div>
                <div class="form-group"><label>RANGO FIN</label><input id="f6" type="number" value="24"></div>
            </div>`;
            btn.onclick = () => {
                const ini = parseInt(document.getElementById('f5').value);
                const fin = parseInt(document.getElementById('f6').value);
                for(let i=ini; i<=fin; i++) {
                    const col = colors[(i-1)%12];
                    db.push({id:Date.now()+i, hub:document.getElementById('f1').value, ref:document.getElementById('f2').value, capacidad:document.getElementById('f4').value+' FO', extra:'Buffer '+Math.ceil(i/12), alim:document.getElementById('f3').value, label:'H-'+i, colorBg:col.b, colorText:col.c||'#fff', cliente:'-', potencia:'-', dist:'0'});
                }
                finishAction();
            };
        }
        else if(type === 'MOD') {
            title.innerText = "üüß PORTAMODULAR"; btn.style.background = "var(--modular)";
            content.innerHTML = `<div class="grid-form">
                <div class="form-group"><label>HUB</label><input id="m1" value="HUB-01"></div>
                <div class="form-group"><label>PM</label><input id="m2" value="PM-01"></div>
                <div class="form-group"><label>SLOT #</label><input id="m3" value="1"></div>
                <div class="form-group"><label>SPLITTER</label><select id="m4"><option value="1x2">1x2</option><option value="1x3">1x3</option><option value="1x4">1x4</option><option value="1x5">1x5</option><option value="1x8">1x8</option><option value="1x16" selected>1x16</option></select></div>
                <div class="form-group"><label>HILO IN (ALIM)</label><input id="m5" value="H-01"></div>
                <div class="form-group"><label>HILO OUT (PREFIJO)</label><input id="m6" value="S-01"></div>
            </div>`;
            btn.onclick = () => {
                const cant = parseInt(document.getElementById('m4').value.split('x')[1]);
                for(let i=1; i<=cant; i++) db.push({id:Date.now()+i, hub:document.getElementById('m1').value, ref:document.getElementById('m2').value, capacidad:document.getElementById('m4').value, extra:'Slot '+document.getElementById('m3').value, alim:document.getElementById('m5').value, label:document.getElementById('m6').value+'-'+i, colorBg:'#f39c12', colorText:'#fff', cliente:'-', potencia:'-', dist:'0'});
                finishAction();
            };
        }
        else if(type === 'SW') {
            title.innerText = "üü© SWITCH"; btn.style.background = "var(--switch)";
            content.innerHTML = `<div class="grid-form">
                <div class="form-group"><label>HUB</label><input id="s1" value="HUB-01"></div>
                <div class="form-group"><label>EQUIPO</label><input id="s2" value="SW-01"></div>
                <div class="form-group"><label>RACK / POS</label><input id="s3" value="R1"></div>
                <div class="form-group"><label>PUERTOS LAN</label><input id="s4" type="number" value="24"></div>
                <div class="form-group"><label>UPLINKS</label><input id="s5" type="number" value="2"></div>
            </div>`;
            btn.onclick = () => {
                const lan = parseInt(document.getElementById('s4').value);
                const up = parseInt(document.getElementById('s5').value);
                for(let i=1; i<=lan; i++) db.push({id:Date.now()+i, hub:document.getElementById('s1').value, ref:document.getElementById('s3').value, capacidad:'1G', extra:'RJ45', alim:document.getElementById('s2').value, label:'P-'+i, colorBg:'#10b981', colorText:'#fff', cliente:'-', potencia:'-', dist:'0'});
                for(let i=1; i<=up; i++) db.push({id:Date.now()+100+i, hub:document.getElementById('s1').value, ref:document.getElementById('s3').value, capacidad:'10G', extra:'SFP+', alim:document.getElementById('s2').value, label:'UP-'+i, colorBg:'#000', colorText:'#fff', cliente:'-', potencia:'-', dist:'0'});
                finishAction();
            };
        }
        else if(type === 'EDFA') {
            title.innerText = "üü• EDFA WDM"; btn.style.background = "var(--edfa)";
            content.innerHTML = `<div class="grid-form">
                <div class="form-group"><label>HUB</label><input id="e1" value="HUB-01"></div>
                <div class="form-group"><label>EQUIPO</label><input id="e2" value="EDFA-01"></div>
                <div class="form-group"><label>IN OLT</label><input id="e3" value="OLT-01"></div>
                <div class="form-group"><label>ENTRADA A</label><input id="e4" value="CATV-A"></div>
                <div class="form-group"><label>ENTRADA B</label><input id="e5" value="CATV-B"></div>
                <div class="form-group"><label>WDM OUT</label><input id="e6" type="number" value="32"></div>
            </div>`;
            btn.onclick = () => {
                const o = parseInt(document.getElementById('e6').value);
                for(let i=1; i<=o; i++) db.push({id:Date.now()+i, hub:document.getElementById('e1').value, ref:document.getElementById('e2').value, capacidad:'WDM', extra:'A:'+document.getElementById('e4').value+' B:'+document.getElementById('e5').value, alim:document.getElementById('e3').value, label:'W-'+i, colorBg:'#e11d48', colorText:'#fff', cliente:'-', potencia:'+19', dist:'0'});
                finishAction();
            };
        }
        else if(type === 'OLT') {
            title.innerText = "üü™ OLT"; btn.style.background = "var(--olt)";
            content.innerHTML = `<div class="grid-form">
                <div class="form-group"><label>HUB</label><input id="o1" value="HUB-01"></div>
                <div class="form-group"><label>OLT</label><input id="o2" value="OLT-01"></div>
                <div class="form-group"><label>SLOT #</label><input id="o3" value="1"></div>
                <div class="form-group"><label>TARJETA</label><select id="o4"><option value="8">8 Puertos</option><option value="16" selected>16 Puertos</option></select></div>
                <div class="form-group"><label>PREFIJO</label><input id="o5" value="PON"></div>
            </div>`;
            btn.onclick = () => {
                const p = parseInt(document.getElementById('o4').value);
                for(let i=1; i<=p; i++) db.push({id:Date.now()+i, hub:document.getElementById('o1').value, ref:document.getElementById('o2').value, capacidad:p+'P', extra:'Slot '+document.getElementById('o3').value, alim:'SFP', label:document.getElementById('o5').value+'-'+i, colorBg:'#8b5cf6', colorText:'#fff', cliente:'-', potencia:'+4', dist:'0'});
                finishAction();
            };
        }
        else if(type === 'USERS') {
            title.innerText = "üë• USUARIOS"; btn.style.display = 'none';
            renderUsers();
        }
        else if(type === 'FILES') {
            title.innerText = "üìÅ EXPORTAR / SISTEMA"; btn.style.display = 'none';
            content.innerHTML = `
                <button onclick="exportExcel()" style="width:100%; padding:15px; background:#107c41; color:white; border:none; border-radius:8px; margin-bottom:12px; font-weight:bold; cursor:pointer;">üì§ EXCEL</button>
                <button onclick="exportPDF()" style="width:100%; padding:15px; background:#e11d48; color:white; border:none; border-radius:8px; margin-bottom:12px; font-weight:bold; cursor:pointer;">üìÑ PDF</button>
                <button onclick="document.getElementById('fIn').click()" style="width:100%; padding:15px; background:#2563eb; color:white; border:none; border-radius:8px; margin-bottom:12px; font-weight:bold; cursor:pointer;">üì• IMPORTAR</button>
                <input type="file" id="fIn" style="display:none" onchange="importExcel(event)">
                <button onclick="if(confirm('¬øBorrar toda la red?')) {db=[]; renderAll();}" style="width:100%; padding:15px; background:black; color:white; border:none; border-radius:8px; font-weight:bold;">‚ö†Ô∏è LIMPIAR SISTEMA</button>`;
        }
    }

    function renderUsers() {
        const content = document.getElementById('panelContent');
        content.innerHTML = `<div style="max-height:200px; overflow:auto; margin-bottom:15px; background:#f8fafc; padding:10px; border-radius:8px; border:1px solid #ddd;">
            ${Object.keys(usersDB).map(u => `<div style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #eee;">
                <div style="font-size:0.75rem;"><b>${u.toUpperCase()}</b><br><small>${usersDB[u].role}</small></div>
                <div><button class="btn-edit" onclick="editUser('${u}')">‚úé</button>${u!=='admin' ? `<button class="btn-danger" onclick="deleteUser('${u}')">‚úñ</button>` : ''}</div>
            </div>`).join('')}
        </div>
        <div class="grid-form">
            <div class="form-group"><label>Usuario</label><input id="nu"></div>
            <div class="form-group"><label>Clave</label><input id="np"></div>
            <div class="form-group" style="grid-column:span 2"><label>Rol</label><select id="nr"><option value="ADMIN">ADMIN</option><option value="LECTOR">LECTOR</option></select></div>
            <button onclick="addUser()" style="grid-column:span 2; background:var(--accent); color:white; padding:12px; border:none; border-radius:6px; font-weight:bold;">GUARDAR USUARIO</button>
        </div>`;
    }

    function addUser() {
        const u = document.getElementById('nu').value.toLowerCase().trim();
        const p = document.getElementById('np').value;
        const r = document.getElementById('nr').value;
        if(u && p) { usersDB[u] = {pass:p, role:r}; renderUsers(); }
    }

    function editUser(u) {
        document.getElementById('nu').value = u;
        document.getElementById('np').value = usersDB[u].pass;
        document.getElementById('nr').value = usersDB[u].role;
    }

    function deleteUser(u) { if(confirm('¬øEliminar?')) { delete usersDB[u]; renderUsers(); } }

    function renderAll() {
        const tbody = document.getElementById('dataTable'); tbody.innerHTML = "";
        const q = document.getElementById('search').value.toLowerCase();
        let t=0, l=0, o=0, p=0, d=0;

        db.forEach((i, idx) => {
            const match = Object.values(i).some(v => String(v).toLowerCase().includes(q));
            if (!match) return;

            t++;
            let est = "LIBRE"; 
            let c = (i.cliente||"-").toUpperCase();
            if(c.startsWith("PROYECTADO")) { est="PROY"; p++; }
            else if(c.startsWith("DA√ëADO") || c.startsWith("FALLO") || c.startsWith("MALOGRADO")) { est="FALLO"; d++; }
            else if(c === "-" || c === "") { est="LIBRE"; l++; }
            else { est="USO"; o++; }

            const row = tbody.insertRow();
            const isAdmin = currentUser.role === 'ADMIN';
            row.innerHTML = `<td><b>${i.hub}</b></td><td>${i.ref}</td><td>${i.capacidad||'FO'}</td><td>${i.extra}</td><td>${i.alim}</td>
            <td><span class="color-tag" style="background:${i.colorBg}">${i.label}</span></td>
            <td><input class="input-inline" value="${i.cliente}" ${isAdmin?'':'readonly'} onchange="db[${idx}].cliente=this.value;renderAll()"></td>
            <td><input class="input-inline" value="${i.potencia}" ${isAdmin?'':'readonly'} onchange="db[${idx}].potencia=this.value"></td>
            <td style="font-weight:900; color:${est==='LIBRE'?'#10b981':est==='USO'?'#ef4444':est==='PROY'?'#f59e0b':'#475569'}">${est}</td>
            <td><input class="input-inline" value="${i.dist||'0'}" ${isAdmin?'':'readonly'} onchange="db[${idx}].dist=this.value"></td>
            <td class="admin-only"><button onclick="db.splice(${idx},1);renderAll()" style="color:red; border:none; background:none;">‚úñ</button></td>`;
        });

        document.getElementById('cTotal').innerText = t;
        document.getElementById('cLibre').innerText = l;
        document.getElementById('cOcupado').innerText = o;
        document.getElementById('cProy').innerText = p;
        document.getElementById('cDanado').innerText = d;
    }

    async function sincronizarGoogle() {
        const btn = document.getElementById('btnSaveTop'); btn.innerText = "ENVIANDO...";
        try {
            await fetch(WEB_APP_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ red: db, usuarios: usersDB }) 
            });
            alert("Guardado correctamente");
        } catch(e) { alert("Error al guardar"); }
        btn.innerText = "GUARDAR";
    }

    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(db);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Red");
        XLSX.writeFile(wb, "Fiber_Argis.xlsx");
    }

    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        const rows = db.map(i => [i.hub, i.ref, i.capacidad, i.extra, i.alim, i.label, i.cliente, i.potencia, i.dist]);
        doc.text("INVENTARIO ARGIS SYSTEM", 14, 15);
        doc.autoTable({ head: [['HUB','REF','CAP','SLOT','ALIM','PTO','CLIENTE','dBm','KM']], body: rows, startY: 20, theme: 'grid', styles: { fontSize: 7 } });
        doc.save("Reporte_Red.pdf");
    }

    function importExcel(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = new Uint8Array(ev.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            db = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            renderAll();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }

    function finishAction() { closePanels(); renderAll(); }
    function closePanels() { document.getElementById('panelFields').classList.remove('active'); document.getElementById('sidebar').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }
</script>
</body>
</html>
